#include <U8g2lib.h>
#include <ELECHOUSE_CC1101_SRC_DRV.h>
#include <RCSwitch.h>
#include <NimBLEDevice.h>
#include <WiFi.h>
#include <esp_wifi.h>

#include <SPI.h>
#include <SD.h>

#ifdef U8X8_HAVE_HW_I2C
#include <Wire.h>
#endif

// ==================== CONFIGURAÇÕES DE PINOS ====================
#define RX_PIN 4
#define TX_PIN 2

// SD (HSPI)
#define SD_CS 17
#define SD_MISO 34
#define SD_MOSI 13
#define SD_SCK 14

// Botoes
#define FREQUENCY_SWITCH_PIN 12
#define BTN_UP     27
#define BTN_LEFT   26
#define BTN_DOWN   25
#define BTN_OK     33
#define BTN_RIGHT  32

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

// ==================== CONFIGURAÇÕES DE TEMPORIZAÇÃO ====================
#define DEBOUNCE_DELAY 10
#define DISPLAY_UPDATE_INTERVAL 50

// ==================== OBJETOS GLOBAIS ====================
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);
RCSwitch mySwitch = RCSwitch();
SPIClass hspi(HSPI);

// ==================== ESTADOS DO SISTEMA ====================
enum SystemState {
  STATE_MENU,
  STATE_RF_REPLAY,
  STATE_RF_RAW,
  STATE_RF_ANALYSER,
  STATE_RF_RANDOM,
  STATE_WIFI_DEAUTH,
  STATE_WIFI_EVIL_PORTAL,
  STATE_BLE_SPAM
};

SystemState currentSystemState = STATE_MENU;

// ==================== VARIÁVEIS GLOBAIS DE RF ====================
struct RFData {
  unsigned long receivedValue = 0;
  int receivedBitLength = 0;
  int receivedProtocol = 0;
  float mhz = 433.92;
  const int rssi_threshold = -75;
};

RFData rfData;

// ==================== FREQUÊNCIAS SUB-GHZ ====================
static const uint32_t subghz_frequency_list[] = {
  300000000, 303875000, 304250000, 310000000, 315000000, 318000000,
  390000000, 418000000, 433075000, 433420000, 433920000, 434420000,
  434775000, 438900000, 868350000, 915000000, 925000000
};

// ==================== WAVEFORM ====================
#define WAVEFORM_SAMPLES 128
int waveform[WAVEFORM_SAMPLES] = {0};

// ==================== BITMAP DA TELA INICIAL ====================
#define scary_width 128
#define scary_height 64
unsigned const char scary_bits[] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0x8F, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0x03, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 0xE0, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xC0, 0x07, 0x00, 0xFE, 0xFF, 0x0F,
                                     0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0x00, 0x03, 0x00,
                                     0xFF, 0xFF, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x03,
                                     0x00, 0x06, 0x00, 0xFF, 0xFF, 0x03, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0x87, 0x00, 0x06, 0x00, 0xFF, 0xFF, 0x03, 0xE0, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x87, 0x05, 0x06, 0x10, 0xFF, 0xFF, 0x01, 0xE1,
                                     0xFF, 0xFB, 0xFF, 0xFF, 0xFF, 0xCF, 0x9F, 0xFF, 0x87, 0x0D, 0x06, 0xBE, 0xFF,
                                     0xFF, 0x81, 0xE3, 0xDF, 0xF9, 0xFF, 0x80, 0xFB, 0xE3, 0xC7, 0xFF, 0x87, 0x0D,
                                     0x06, 0xBE, 0xFF, 0xFF, 0xC1, 0xE7, 0x07, 0xE8, 0xF3, 0x80, 0xF1, 0xE0, 0xE1,
                                     0xFF, 0x87, 0x0F, 0x06, 0xFF, 0xFF, 0xFF, 0xC0, 0xFF, 0x03, 0xC8, 0xE0, 0x03,
                                     0x60, 0x60, 0xE0, 0xFF, 0x83, 0x0F, 0x06, 0xFF, 0xFF, 0xFF, 0xC1, 0xFF, 0x00,
                                     0x0C, 0x80, 0x03, 0xC0, 0xE0, 0xE0, 0xFF, 0x83, 0x0F, 0x07, 0xFF, 0xFF, 0xFF,
                                     0x01, 0xFE, 0x00, 0x0C, 0x00, 0x03, 0xC0, 0xE0, 0xE1, 0xFF, 0x87, 0x07, 0x07,
                                     0xF7, 0xFF, 0xFF, 0x01, 0xFC, 0x20, 0x0C, 0x00, 0x83, 0xC0, 0xE0, 0xE1, 0xFF,
                                     0x83, 0x03, 0x07, 0xF3, 0xFF, 0xFF, 0x03, 0xF8, 0x30, 0x0C, 0x06, 0x83, 0xC1,
                                     0xE0, 0xC1, 0xFF, 0x83, 0x00, 0x07, 0xF3, 0xFF, 0xFF, 0x03, 0x70, 0xB0, 0x0C,
                                     0x07, 0x83, 0xC1, 0xE0, 0xC1, 0xFF, 0x87, 0x80, 0x07, 0xF0, 0xFF, 0xFF, 0x03,
                                     0x60, 0xF0, 0x8C, 0x03, 0x83, 0xC1, 0xE0, 0xE1, 0xFF, 0x07, 0xC0, 0x07, 0xF0,
                                     0xFF, 0xFF, 0xEF, 0x60, 0xF8, 0xE6, 0x00, 0x83, 0xE1, 0xE0, 0xE1, 0xFF, 0x07,
                                     0xC0, 0x07, 0xF0, 0xFF, 0xFF, 0xEF, 0x61, 0xF8, 0x3E, 0x00, 0x83, 0xE3, 0xE0,
                                     0xE1, 0xFF, 0x03, 0x00, 0x07, 0xF0, 0xFF, 0xFF, 0xFF, 0x21, 0xF8, 0x1E, 0x00,
                                     0x83, 0xE3, 0xE1, 0xE1, 0xFF, 0x03, 0x00, 0x07, 0xF3, 0xFF, 0xFF, 0xFF, 0x01,
                                     0xF8, 0x0F, 0x0C, 0x83, 0xFB, 0xE0, 0xE1, 0xFF, 0x83, 0x03, 0x07, 0xF3, 0xFF,
                                     0xFF, 0xFF, 0x01, 0xF8, 0x0F, 0x0E, 0x83, 0xFF, 0xF0, 0xE1, 0xFF, 0x83, 0x07,
                                     0x0F, 0xF7, 0xFF, 0xFF, 0xF7, 0x01, 0xF8, 0x05, 0x0F, 0x83, 0xFB, 0xE0, 0xE1,
                                     0xFF, 0x83, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0x63, 0x00, 0xF8, 0x85, 0x0F, 0xC3,
                                     0xFF, 0x60, 0xE0, 0xFF, 0x83, 0x07, 0x0F, 0xFF, 0xFF, 0xFF, 0x43, 0x60, 0xF0,
                                     0x84, 0x0F, 0xC3, 0xFF, 0x00, 0xE0, 0xFF, 0x07, 0x07, 0x0F, 0xFF, 0xFF, 0xFF,
                                     0x43, 0x60, 0xF0, 0x0C, 0x0B, 0xC3, 0xFF, 0x00, 0xE0, 0xFF, 0x03, 0x87, 0x0F,
                                     0xFF, 0xFF, 0xFF, 0x03, 0xF0, 0x00, 0x0C, 0x03, 0xC3, 0xFF, 0x03, 0xE0, 0xFF,
                                     0x03, 0x87, 0x0F, 0xFF, 0xFF, 0xFF, 0x03, 0xF0, 0x00, 0x0C, 0x00, 0xE3, 0xFF,
                                     0x0F, 0xE0, 0xFF, 0x03, 0x87, 0x8F, 0xFF, 0xFF, 0xFF, 0x03, 0xF0, 0x01, 0x0C,
                                     0x00, 0xE2, 0xFF, 0x0E, 0xE0, 0xFF, 0x03, 0x87, 0x8F, 0xFF, 0xFF, 0xFF, 0x03,
                                     0xF4, 0x07, 0x1C, 0x00, 0xEA, 0xFF, 0xDE, 0xE0, 0xFF, 0x01, 0x87, 0x0F, 0xFF,
                                     0xFF, 0xFF, 0x0F, 0xF6, 0x0F, 0x1C, 0x2E, 0xF8, 0xFF, 0xDC, 0xE0, 0xFF, 0x00,
                                     0x86, 0x8F, 0xFF, 0xFF, 0xFF, 0x1F, 0xFF, 0x6F, 0xBC, 0xAF, 0xFB, 0xFF, 0xFC,
                                     0xE0, 0xFF, 0xFF, 0xC7, 0x8F, 0xFF, 0xFF, 0xFF, 0x9F, 0xFF, 0x7F, 0xBC, 0xFF,
                                     0xFB, 0xFF, 0x78, 0xF0, 0xFF, 0xFF, 0xC7, 0xDF, 0xFF, 0xFF, 0xFF, 0xDF, 0xFF,
                                     0xFF, 0xFC, 0xFF, 0xFF, 0xFF, 0x30, 0xF8, 0xFF, 0xFF, 0xCF, 0xDF, 0xFF, 0xFF,
                                     0xFF, 0xDF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0x00, 0xFC, 0xFF, 0xFF, 0xEF,
                                     0xDF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0x00, 0xFC,
                                     0xFF, 0xFF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF,
                                     0xFF, 0x00, 0xFD, 0xFF, 0xFF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0x04, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0E, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xBE, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
                                     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x7F, 0xFE,
                                     0xFF, 0xFF, 0xFD, 0xFF, 0xFF, 0xFD, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFC, 0x7F, 0xFF, 0xFF, 0xFF, 0xFC, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0x87, 0xFC, 0xFF, 0xFF, 0xFC, 0x7F,
                                     0x3F, 0xF8, 0x87, 0xFF, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0xCF, 0x04, 0x04,
                                     0x80, 0x0F, 0x60, 0xDF, 0xF1, 0x69, 0xFF, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF,
                                     0xCF, 0x64, 0x26, 0xF9, 0x65, 0x32, 0xFF, 0xF3, 0x59, 0xFE, 0xFF, 0xFF, 0xFD,
                                     0x7F, 0xFE, 0xFF, 0xCF, 0x64, 0x26, 0x01, 0x64, 0x32, 0x1F, 0xF2, 0x53, 0xFE,
                                     0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0xCF, 0x64, 0xA7, 0xBD, 0x64, 0x12, 0x9F,
                                     0xF9, 0x53, 0xFE, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0xCF, 0xA4, 0xA7, 0x9F,
                                     0x64, 0x12, 0x9F, 0xFF, 0x53, 0xFE, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0xCF,
                                     0xC4, 0xE6, 0x9B, 0x64, 0x22, 0x9F, 0xF6, 0x53, 0xFE, 0xFF, 0xFF, 0xFD, 0x7F,
                                     0xFE, 0xFF, 0xC7, 0x64, 0xE6, 0x99, 0x64, 0x22, 0x9F, 0xF2, 0x53, 0xFE, 0xFF,
                                     0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0x8F, 0x66, 0xE6, 0xD9, 0x64, 0x32, 0x9F, 0xF2,
                                     0x71, 0xFE, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0x1F, 0x02, 0xE3, 0x00, 0x00,
                                     0x13, 0x9F, 0x32, 0x63, 0xFE, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF, 0xFF, 0x1F, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFB, 0x9F, 0x33, 0x87, 0xFF, 0xFF, 0xFF, 0xFD, 0x7F, 0xFF,
                                     0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFB, 0x0F, 0xA0, 0xDF, 0xFF, 0xFF, 0xFF,
                                     0xFD, 0x7F, 0xFC, 0xFF, 0xFB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFB, 0xFF, 0xFF, 0xFB,
                                     0x7F, 0xEF, 0xF7, 0xFC, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
                                     0xFF, 0xFF, 0xFF,
                                   };

// ==================== ESTRUTURA DO MENU ====================
#define ICON_WIDTH 32
#define ICON_HEIGHT 32
#define ICON_GAP 4
#define ICON_Y 32 + ICON_GAP

struct menu_entry_type {
  const uint8_t *font;
  uint16_t icon;
  const char *name;
  const menu_entry_type *submenu;
};

struct menu_state {
  uint8_t position;
  const menu_entry_type *menu;
};

// ==================== SUBMENUS ====================
const menu_entry_type radio_freq_submenu[] = {
  { u8g2_font_open_iconic_all_4x_t, 211, "Replay", NULL },
  { u8g2_font_open_iconic_all_4x_t, 238, "Raw", NULL },
  { u8g2_font_open_iconic_all_4x_t, 165, "Analyser", NULL },
  { u8g2_font_open_iconic_all_4x_t, 240, "Random", NULL },
  { NULL, 0, NULL, NULL }
};

const menu_entry_type wifi_submenu[] = {
  { u8g2_font_open_iconic_all_4x_t, 104, "Evil portal", NULL },
  { u8g2_font_open_iconic_all_4x_t, 153, "Deauther", NULL },
  { u8g2_font_open_iconic_all_4x_t, 175, "Internet", NULL },
  { NULL, 0, NULL, NULL }
};

const menu_entry_type bluetooth_submenu[] = {
  { u8g2_font_open_iconic_all_4x_t, 230, "BLE Spam", NULL },
  { NULL, 0, NULL, NULL }
};

const menu_entry_type menu_entry_list[] = {
  { u8g2_font_open_iconic_all_4x_t, 84, "Radio Freq", radio_freq_submenu },
  { u8g2_font_open_iconic_all_4x_t, 247, "Wifi", wifi_submenu },
  { u8g2_font_open_iconic_all_4x_t, 94, "Bluetooth", bluetooth_submenu },
  { u8g2_font_open_iconic_all_4x_t, 129, "Config", NULL },
  { NULL, 0, NULL, NULL }
};

menu_state current_state = { 0, menu_entry_list };

// ==================== CLASSE DE DEBOUNCE ====================
class Button {
  private:
    uint8_t pin;
    unsigned long lastDebounceTime = 0;
    bool lastState = HIGH;
    bool currentState = HIGH;

  public:
    Button(uint8_t p) : pin(p) {
      pinMode(pin, INPUT_PULLUP);
    }

    bool isPressed() {
      bool reading = digitalRead(pin);

      if (reading != lastState) {
        lastDebounceTime = millis();
      }

      if ((millis() - lastDebounceTime) > DEBOUNCE_DELAY) {
        if (reading != currentState) {
          currentState = reading;
          lastState = reading;
          return (currentState == LOW);
        }
      }

      lastState = reading;
      return false;
    }

    bool isHeld() {
      return digitalRead(pin) == LOW;
    }
};

// ==================== INSTÂNCIAS DOS BOTÕES ====================
Button btnSwitch(FREQUENCY_SWITCH_PIN);
Button btnUp(BTN_UP);
Button btnLeft(BTN_LEFT);
Button btnDown(BTN_DOWN);
Button btnOk(BTN_OK);
Button btnRight(BTN_RIGHT);

// ==================== FUNÇÕES DE DISPLAY ====================
void displayInit() {
  u8g2.begin();
  u8g2.enableUTF8Print();
  u8g2.setFlipMode(3);
  u8g2.setFont(u8g2_font_6x10_tf);
}

void drawMenu(menu_state *state) {
  static unsigned long lastUpdate = 0;
  if (millis() - lastUpdate < DISPLAY_UPDATE_INTERVAL) return;
  lastUpdate = millis();

  int16_t x = (u8g2.getDisplayWidth() - ICON_WIDTH) / 2;
  uint8_t i = state->position;

  u8g2.clearBuffer();
  u8g2.setFont(state->menu[i].font);
  u8g2.drawGlyph(x, ICON_Y, state->menu[i].icon);

  for (int j = 1; j <= 3; j++) {
    u8g2.drawFrame(x - j, ICON_Y - ICON_HEIGHT - j, ICON_WIDTH + 2 * j, ICON_HEIGHT + 2 * j);
  }

  u8g2.setFont(u8g2_font_6x10_tf);
  u8g2.setCursor((u8g2.getDisplayWidth() - u8g2.getStrWidth(state->menu[i].name)) / 2,
                 u8g2.getDisplayHeight() - 5);
  u8g2.print(state->menu[i].name);
  u8g2.sendBuffer();
}

void showMessage(const char* line1, const char* line2 = NULL, const char* line3 = NULL) {
  u8g2.clearBuffer();
  u8g2.setCursor(0, 20);
  u8g2.print(line1);
  if (line2) {
    u8g2.setCursor(0, 35);
    u8g2.print(line2);
  }
  if (line3) {
    u8g2.setCursor(0, 50);
    u8g2.print(line3);
  }
  u8g2.sendBuffer();
}

// ==================== SETUP DE MÓDULOS ====================
void setupDisplay() {
  Serial.println(F("Init Display..."));
  displayInit();
  u8g2.drawStr(0, 20, "Display OK!");
  u8g2.sendBuffer();
  delay(500);
}

void setupCC1101() {
  Serial.println(F("Init CC1101..."));

  if (!ELECHOUSE_cc1101.getCC1101()) {
    Serial.println(F("ERROR: CC1101 not found!"));
    showMessage("ERROR:", "CC1101 not found!");
    while (1) delay(1000);
  }

  ELECHOUSE_cc1101.Init();
  rfData.mhz = (digitalRead(FREQUENCY_SWITCH_PIN) == LOW) ? 315.00 : 433.92;
  ELECHOUSE_cc1101.setMHZ(rfData.mhz);
  ELECHOUSE_cc1101.SetRx();

  mySwitch.enableReceive(RX_PIN);
  mySwitch.enableTransmit(TX_PIN);

  Serial.println(F("CC1101 OK!"));
  u8g2.drawStr(0, 30, "CC1101 OK!");
  u8g2.sendBuffer();
  delay(500);
}

// ==================== MÁQUINA DE ESTADOS ====================
void handleMenuNavigation() {
  if (btnRight.isPressed() && current_state.menu[current_state.position + 1].font != NULL) {
    current_state.position++;
    drawMenu(&current_state);
  }

  if (btnLeft.isPressed() && current_state.position > 0) {
    current_state.position--;
    drawMenu(&current_state);
  }

  if (btnOk.isPressed()) {
    if (current_state.menu[current_state.position].submenu != NULL) {
      current_state.menu = current_state.menu[current_state.position].submenu;
      current_state.position = 0;
      drawMenu(&current_state);
    } else {
      const char* name = current_state.menu[current_state.position].name;
      if (strcmp(name, "Replay") == 0) currentSystemState = STATE_RF_REPLAY;
      else if (strcmp(name, "Raw") == 0) currentSystemState = STATE_RF_RAW;
      else if (strcmp(name, "Analyser") == 0) currentSystemState = STATE_RF_ANALYSER;
      else if (strcmp(name, "Random") == 0) currentSystemState = STATE_RF_RANDOM;
      else if (strcmp(name, "BLE Spam") == 0) currentSystemState = STATE_BLE_SPAM;
      else if (strcmp(name, "Deauther") == 0) currentSystemState = STATE_WIFI_DEAUTH;
      else if (strcmp(name, "Evil portal") == 0) currentSystemState = STATE_WIFI_EVIL_PORTAL;
    }
  }

  if (btnUp.isPressed() && current_state.menu != menu_entry_list) {
    current_state.menu = menu_entry_list;
    current_state.position = 0;
    drawMenu(&current_state);
  }
}

void executeState() {
  switch (currentSystemState) {
    case STATE_RF_REPLAY:
      Detect();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_RF_RAW:
      Raw();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_RF_ANALYSER:
      Analyser();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_RF_RANDOM:
      SendRandom();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_BLE_SPAM:
      Blesetup();
      Bleloop();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_WIFI_DEAUTH:
      Deauther();
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_WIFI_EVIL_PORTAL:
      showMessage("In progress...");
      delay(2000);
      currentSystemState = STATE_MENU;
      drawMenu(&current_state);
      break;
    case STATE_MENU:
    default: handleMenuNavigation();
      break;
  }
}

// ==================== SETUP PRINCIPAL ====================
void setup() {
  Serial.begin(115200);
  delay(500);
  Serial.println(F("\n\n=== ScaryRF Starting ==="));

  pinMode(FREQUENCY_SWITCH_PIN, INPUT_PULLUP);

  setupDisplay();
  setupCC1101();
  initSD();

  // Tela inicial
  u8g2.clearBuffer();
  u8g2.firstPage();
  do {
    u8g2.drawXBMP(0, 0, scary_width, scary_height, scary_bits);
  }
  while (u8g2.nextPage());

  // Aguarda qualquer botão
  while (!btnOk.isPressed() && !btnRight.isPressed() &&
         !btnLeft.isPressed() && !btnUp.isPressed() && !btnDown.isPressed()) delay(10);

  Serial.println(F("Setup complete!"));
}

// ==================== LOOP PRINCIPAL ====================
void loop() {
  executeState();
  delay(10);
}
